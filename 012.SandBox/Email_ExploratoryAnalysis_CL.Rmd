---
title: "Email - Exploratory Analysis"
author: "Chloe Li"
date: "September 21, 2016"
output:
  pdf_document:
    highlight: monochrome
  html_document:
    highlight: pygments
    theme: united
  word_document: default
header-includes: \usepackage{graphicx} \usepackage{fancyhdr} \pagestyle{fancy} \setlength\headheight{28pt}
  \fancyhead[L]{\includegraphics[width=0.5cm]{mobovidalogo.png}} \fancyfoot[LE,RO]{CL}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r load, message=FALSE, warning=FALSE, include=FALSE}

#--------------------------------------------------LOAD-------------------------------------------------------#
rm(list = ls())
#set directory
setwd("/Users/chloeli/Documents/02. EmailPrediction_CL/011.Data")

#load neccessary packages
#Note, you might need to install pacman first
pacman::p_load("gridExtra","ggplot2", "dplyr","lubridate","reshape2","data.table","quantmod","lme4","lattice","plyr","broom",'ReporteRs',"knitr","xtable", "cluster","fpc","factoextra","grid","gridExtra")
      
#load data
RFM_DT <- read.csv("RRFFK_220K.csv") #this is aggregated data after David Liu rank riid by recency and frequency

RFM_DT_orig <- RFM_DT #reassign the dataset into new vector for clustering purpose

#reformat data for graphing purpose
RFM_DT$riid <- as.character(RFM_DT$riid)
#change multiple variables into factor type
cols = c(2, 3, 4,5)
RFM_DT[cols] <- lapply(RFM_DT[cols], factor)

#RFM_DT$conversions <- as.factor(RFM_DT$conversions)


#------------------------------------------------TRANSFORM-----------------------------------------------------#
#this is a very stupid way of grouping multiple variables and summarise them


#transform the data from wide to long
#RFM_DT_gr <- melt(RFM_DT, id=c(1,6), measure=c("Ro", "Rc", "Fc","Fo"))

Groupby_Ro <- dplyr::group_by(RFM_DT, Ro)
SumRo <- dplyr::summarise(Groupby_Ro,
                          Total_Conversion = sum(conversions),
                          Num_riid = length(riid))

Groupby_Rc <- dplyr::group_by(RFM_DT, Rc)
SumRc <- dplyr::summarise(Groupby_Rc,
                          Total_Conversion = sum(conversions),
                          Num_riid = length(riid))


Groupby_Fc <- dplyr::group_by(RFM_DT, Fc)
SumFc <- dplyr::summarise(Groupby_Fc,
                          Total_Conversion = sum(conversions),
                          Num_riid = length(riid))

Groupby_Fo <- dplyr::group_by(RFM_DT, Fo)
SumFo <- dplyr::summarise(Groupby_Fo,
                          Total_Conversion = sum(conversions),
                          Num_riid = length(riid))



#combine dataset
SumRo$Ro_ratio <- SumRo$Total_Conversion / SumRo$Num_riid

SumRo$Rc <- SumRc$Total_Conversion
SumRo$Rc_id <- SumRc$Num_riid
SumRo$Rc_ratio <- SumRo$Rc/SumRo$Rc_id

SumRo$Fc <- SumFc$Total_Conversion
SumRo$Fc_id <- SumFc$Num_riid
SumRo$Fc_ratio <- SumRo$Fc/SumRo$Fc_id

SumRo$Fo <- SumFo$Total_Conversion
SumRo$Fo_id <- SumFo$Num_riid
SumRo$Fo_ratio <- SumRo$Fo/SumRo$Fo_id

#transform the data from wide to long
SumRo_Transformed <- melt(SumRo, id=1, measure=c("Ro_ratio", "Rc_ratio", "Fc_ratio","Fo_ratio"))
#str(SumRo_Transformed)

#rename the variables
SumRo_Transformed <- dplyr::select(SumRo_Transformed, RFM_Score = Ro, Variable = variable, everything())



SumRo_totalconversion <- dplyr::select(SumRo,RFM_Score = Ro, Ro = Total_Conversion,Rc, Fc, Fo)

#transform the data from wide to long
SumRo_totalConversion_Transformed <- melt(SumRo_totalconversion, id=1, measure=c("Ro", "Rc", "Fc","Fo"))
#str(SumRo_Transformed)

#rename the variables
SumRo_totalConversion_Transformed <- dplyr::select(SumRo_totalConversion_Transformed, everything(), Variable = variable, everything())




SumRo <- dplyr::select(SumRo, Ro, Ro_ratio, Rc_ratio, Fc_ratio, Fo_ratio)
#rename
SumRo <- dplyr::select(SumRo, RFM_Score = Ro, everything())



```

## Introduction
- This documents the exploratory analysis process for email prediction project.
- The sample of input data is shown as below restructured and sent by David Liu:

```{r, echo=FALSE, message=FALSE, warning=FALSE}
kable(head(RFM_DT_orig))
```

- Explanations of variables:
    + riid: unique identifier of email receivers
    + Ro: recency score of open. The higher the score is, the most recent action was taken by the customer.
    + Rc: recency score of click. Same as Ro. Table below shows the number of days passed associated with the score.
    + Fo: life time open rate; number of opens/number of sent. The higher the score is, the higher the rate is.
    + Fc: life time click rate; number of clicks/number of sent. Same logic as above.
    + conversions: number of times the customer converted.

```{r table_Var, echo=FALSE, message=FALSE, warning=FALSE, results='asis', warnings=FALSE}
tabl <- "
| Score      | 7 | 6 | 5  |  4 |  3 |  2 |   1     |
|-----------:|--:|--:|---:|---:|---:|---:|--------:|
|Days Before | 3 | 7 | 14 | 30 | 60 | 90 | LifeTime|  
"
cat(tabl) # output the table in a format good for HTML/PDF/docx conversion
```

\pagebreak
    

## Preliminary Analysis
- Comparison among different RFM group in total conversions.
- Note: the data is not normalized yet. That is, the number of sent is very different in different group.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
#graph a scatter plot for each RFM score and see how much total conversions relate to each categories
ggplot(SumRo_totalConversion_Transformed, aes(x=RFM_Score, y=value, colour=Variable, shape=Variable)) + 
  geom_point(alpha=1,size = 4) + 
  scale_size_area() + 
  scale_colour_brewer(palette = "Set1") +
  ggtitle("Total Conversions by RF") +
  ylab("Total Conversions")


```

\pagebreak

- Therefore, we created this graph to show comparison among four groups in showing the relationship between the score and conversion ratio.
- Conversion ratio is calculated by total number of conversion for a specific group / number of riid (customers).
- However, still has not yet considered the number of sent effect.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
#graph a scatter plot for each RFM score and see how much total conversions relate to each categories
ggplot(SumRo_Transformed, aes(x=RFM_Score, y=value, colour=Variable, shape=Variable)) + 
  geom_point(alpha=1,size = 4) + 
  scale_size_area() + 
  scale_colour_brewer(palette = "Set1") +
  ggtitle("Conversion Ratio by RF") +
  ylab("Conversion Ratio")


##########
#will change to sent/total number of riid


```

\pagebreak

- Histogram on four groups to count number of riid per score.
- To see how many membership per score for each group.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
#stupid way to graph histograms in one plot
PRo = ggplot(RFM_DT_orig, aes(x=Ro)) + 
  geom_histogram(bins = 30,fill = "#CC6666") + ylab("Number of Membership")
PRc = ggplot(RFM_DT_orig, aes(x=Rc)) + 
  geom_histogram(bins = 30,fill = "#0072B2") + ylab("Number of Membership")
PFc = ggplot(RFM_DT_orig, aes(x=Fc)) + 
  geom_histogram(bins = 30,fill = "#009E73") + ylab("Number of Membership")
PFo = ggplot(RFM_DT_orig, aes(x=Fo)) + 
  geom_histogram(bins = 30,fill = "#9999CC") + ylab("Number of Membership")

source("/Users/chloeli/Documents/02. EmailPrediction_CL/017. R_Function_CL_Email/multiplot_fun.R")

multiplot(PRo,PRc,PFc, PFo, cols=2)


```







```{r, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# Determine number of clusters

k_ready <- RFM_DT_orig[,-1]
k_ready <- k_ready[,-5]

#wss <- (nrow(k_ready)-1)*sum(apply(k_ready,2,var))
#for (i in 2:15) wss[i] <- sum(kmeans(k_ready, 
#  	centers=i)$withinss)
#plot(1:15, wss, type="b", xlab="Number of Clusters",
#  ylab="Within groups sum of squares")

fviz_nbclust(k_ready, kmeans, method = "wss") +
    geom_vline(xintercept = 3, linetype = 2)


# K-Means Cluster Analysis
fit <- kmeans(k_ready, 4) # 4 cluster solution
# get cluster means 
aggregate(k_ready,by=list(fit$cluster),FUN=mean)
# append cluster assignment
RFM_DT_orig <- data.frame(RFM_DT_orig, fit$cluster)
```


```{r, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
#set directory
setwd("/Users/chloeli/Documents/02. EmailPrediction_CL/011.Data")

email_users <- read.csv("emails_useremailstats_partial.csv")




```


